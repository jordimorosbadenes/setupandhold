const l=document.querySelector(".puzzle-shell")?.getAttribute("data-api-base")||"";let u=!1,i=!1,g=0,h=0;const B=()=>{const e=document.getElementById("backend-wait"),t=document.querySelector(".puzzle-shell");e?.classList.add("hide"),t?.classList.remove("blocked"),document.getElementById("backend-fallback-style")?.remove(),setTimeout(()=>{try{window.dispatchEvent(new Event("resize"))}catch{}if(typeof window.init3DViewer=="function")try{window.init3DViewer()}catch(n){console.warn("init3DViewer fallo:",n)}},50)},f=()=>{u&&i&&B()},z=async e=>{const t=e.endsWith("/")?e.slice(0,-1):e;try{const n=new AbortController,o=setTimeout(()=>n.abort(),8e3),a=await fetch(`${t}/health`,{signal:n.signal});return clearTimeout(o),a.ok}catch{return!1}},p=()=>{if(!l||i)return;const e=l,t=e.endsWith("/")?e.slice(0,-1):e,n=document.createElement("script"),o=`?v=${Date.now()}-${h}`;n.src=`${t}/static/app.js${o}`,n.defer=!0,n.addEventListener("load",()=>{i=!0,f()}),n.addEventListener("error",a=>{h+=1,console.warn("[Puzzle] No se pudo cargar app.js del backend",a);const s=document.querySelector(".backend-status");s&&(s.textContent="Reintentando app.js del backend..."),setTimeout(p,Math.min(4e3+h*500,12e3))}),document.body.appendChild(n)};window._threeReady?p():window.addEventListener("three-ready",p,{once:!0});(()=>{if(!l){const s=document.querySelector(".backend-status");s&&(s.textContent="Falta configurar PUBLIC_PUZZLEGEN_URL.");return}const e=document.getElementById("backend-style");if(!e){u=!0,f();return}const t=l,n=t.endsWith("/")?t.slice(0,-1):t,o=s=>{const d=document.querySelector(".backend-status");d&&(d.textContent=s)},a=()=>{g+=1;const s=`?v=${Date.now()}-${g}`;e.href=`${n}/static/style.css${s}`,o("Reintentando estilos del backend...")};e.addEventListener("load",()=>{u=!0,f()}),e.addEventListener("error",s=>{console.warn("[Puzzle] No se pudo cargar style.css del backend",s),setTimeout(a,Math.min(3e3+g*500,1e4))}),setTimeout(()=>{u||a()},5e3)})();(function(){if(!l)return;const t=l,n=async()=>{if(await z(t)){const a=document.querySelector(".backend-status");if(a&&(a.textContent="Backend listo, cargando interfaz..."),!u){const s=document.getElementById("backend-style");s&&s.dispatchEvent(new Event("error"))}i||p(),f();return}setTimeout(n,3e3)};n()})();const _=["generate-btn","solve-10-btn","solve-50-btn","prev-btn","next-btn","original-btn","export-stl-btn","btn-isometric","btn-flat"],C=()=>{_.forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("click",n=>{if(i)return;n.preventDefault(),n.stopPropagation();const o=document.getElementById("status")||document.getElementById("status-viewer");o&&(o.textContent="Cargando interfaz...")},!0)})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",C,{once:!0}):C();const k=e=>{const t=document.getElementById("btn-isometric"),n=document.getElementById("btn-flat");if(!t||!n)return;const o=e==="isometric";t.classList.toggle("active",o),n.classList.toggle("active",!o),t.setAttribute("aria-pressed",o?"true":"false"),n.setAttribute("aria-pressed",o?"false":"true")},I=()=>{const e=document.getElementById("btn-isometric"),t=document.getElementById("btn-flat");!e||!t||(e.setAttribute("type","button"),t.setAttribute("type","button"),e.setAttribute("aria-pressed",e.classList.contains("active")?"true":"false"),t.setAttribute("aria-pressed",t.classList.contains("active")?"true":"false"),e.addEventListener("click",()=>{i&&k("isometric")},!0),t.addEventListener("click",()=>{i&&k("flat")},!0),!e.classList.contains("active")&&!t.classList.contains("active")&&k("isometric"))};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I,{once:!0}):I();(()=>{const e=document.querySelector(".puzzle-shell")?.getAttribute("data-gumroad-product-id")?.trim()||"",t=document.querySelector("[data-premium-lock]"),n=document.querySelector("[data-premium-open]"),o=document.querySelector("[data-premium-gate]"),a=document.querySelector("[data-premium-key]"),s=document.querySelector("[data-premium-unlock]"),d=document.querySelector("[data-premium-error]"),E=c=>{t&&t.classList.toggle("is-unlocked",c)},r=c=>{d&&(d.textContent=c,d.style.display=c?"block":"none")},w=()=>{if(E(!1),r(""),n?.classList.remove("is-hidden"),o?.classList.add("premium-gate--hidden"),n?.addEventListener("click",()=>{n.classList.add("is-hidden"),o?.classList.remove("premium-gate--hidden"),setTimeout(()=>a?.focus(),0)}),!s||!a)return;const c=async()=>{const m=(a.value||"").trim();if(!m){r("Introduce una clave válida.");return}if(!e){r("Falta configurar el product_id de Gumroad (PUBLIC_GUMROAD_PRODUCT_ID).");return}const S=s.textContent;s.disabled=!0,s.textContent="Verificando…",r("");try{const y=new URLSearchParams({product_id:e,license_key:m,increment_uses_count:"false"}),L=await fetch("https://api.gumroad.com/v2/licenses/verify",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:y}),v=await L.json().catch(()=>null);if(!L.ok||!v||v.success!==!0){r("Clave no válida. Revisa que la hayas copiado tal cual.");return}const b=v.purchase||{};if(b.refunded||b.disputed||b.chargebacked){r("Esta compra no está activa (reembolso o disputa).");return}E(!0),r("")}catch(y){console.warn("[Premium] Error verificando license key",y),r("No se pudo verificar la clave ahora. Inténtalo de nuevo.")}finally{s.disabled=!1,s.textContent=S}};s.addEventListener("click",c),a.addEventListener("keydown",m=>{m.key==="Enter"&&c()})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w,{once:!0}):w()})();
