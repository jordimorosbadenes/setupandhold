---
import BaseLayout from '../layouts/BaseLayout.astro';
import { withBase } from '../utils/withBase';
import { CONTACT_EMAIL, CONTACT_EMAIL_HREF, LINKEDIN_URL } from '../config/site';

const pngUrl = withBase('/img/asic-mousepad.png');
const svgFallbackUrl = withBase('/img/asic-mousepad.svg');
---

<BaseLayout
  title="Alfombrilla ASIC"
  description="Una alfombrilla de rat칩n con un cheatsheet visual de dise침o ASIC."
>
  <section class="hero mousepad-hero">
    <div class="post-prose">
      <h1>Alfombrilla ASIC</h1>
      <p>
        Dise침칠 esta alfombrilla para tener a mano lo esencial cuando est치s en modo RTL.
        Pasa el rat칩n por encima para hacer zoom con una lupa.
      </p>
      <p>
        Contiene sintaxis Verilog b치sica, operadores, conceptos t칠cnicos como setup/hold, metastabilidad, CDC, clock gating, etc. 칔salo como referencia r치pida mientras trabajas o estudias! 游뗵
      </p>

      <div class="hero-actions">
        <a class="button" href={withBase('/posts/2-alfombrilla-asic')}>Ver la entrada en el blog</a>
      </div>
    </div>

    <div class="magnifier" data-magnifier>
      <div class="magnifier-stage" data-stage aria-label="Lupa: mueve el rat칩n por la imagen">
        <img
          class="magnifier-image"
          data-image
          src={pngUrl}
          alt="Alfombrilla ASIC"
          loading="lazy"
          decoding="async"
          onerror={`this.onerror=null; this.src='${svgFallbackUrl}';`}
        />
        <div class="magnifier-lens" data-lens aria-hidden="true"></div>
      </div>
    </div>

    <!-- Modal para zoom en m칩vil -->
    <div class="mousepad-modal" data-modal style="display: none;">
      <div class="mousepad-modal__overlay" data-modal-overlay></div>
      <div class="mousepad-modal__content">
        <button class="mousepad-modal__close" data-modal-close aria-label="Cerrar">&times;</button>
        <img
          class="mousepad-modal__image"
          data-modal-image
          src={pngUrl}
          alt="Alfombrilla ASIC ampliada"
          onerror={`this.onerror=null; this.src='${svgFallbackUrl}';`}
        />
      </div>
    </div>

    <div class="mousepad-contact">
      <h2>쯈uieres tu alfombrilla?</h2>
      <p class="mousepad-contact__text">
        Cont치ctame y te digo c칩mo conseguirla (disponibilidad, precio y env칤o).
      </p>
      <div class="mousepad-contact__actions">
        <a class="button secondary" href={LINKEDIN_URL} target="_blank" rel="noreferrer">Escr칤beme por LinkedIn</a>
        <a class="button secondary" href={CONTACT_EMAIL_HREF}>{CONTACT_EMAIL}</a>
      </div>
    </div>
  </section>

  <style>
    .mousepad-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mousepad-modal__overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
    }

    .mousepad-modal__content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mousepad-modal__image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      user-select: none;
      -webkit-user-drag: none;
    }

    .mousepad-modal__close {
      position: absolute;
      top: -40px;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .mousepad-modal__close:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    /* Mobile specific styles */
    @media (max-width: 768px) {
      .mousepad-modal__close {
        top: 10px;
        right: 10px;
      }

      .magnifier-stage {
        cursor: pointer;
      }
    }
  </style>

  <script is:inline>
    (() => {
      const root = document.querySelector('[data-magnifier]');
      if (!root) return;

      const stage = root.querySelector('[data-stage]');
      const image = root.querySelector('[data-image]');
      const lens = root.querySelector('[data-lens]');
      if (!stage || !image || !lens) return;

      // Check if device is mobile
      const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;

      const modal = document.querySelector('[data-modal]');
      const modalImage = document.querySelector('[data-modal-image]');
      const modalClose = document.querySelector('[data-modal-close]');
      const modalOverlay = document.querySelector('[data-modal-overlay]');

      const zoom = 3.25;

      const updateLens = (clientX, clientY) => {
        const imgRect = image.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();

        const x = clientX - imgRect.left;
        const y = clientY - imgRect.top;

        if (x < 0 || y < 0 || x > imgRect.width || y > imgRect.height) {
          lens.style.display = 'none';
          return;
        }

        lens.style.display = 'block';
        lens.style.left = `${clientX - stageRect.left}px`;
        lens.style.top = `${clientY - stageRect.top}px`;

        const src = image.currentSrc || image.src;
        lens.style.backgroundImage = `url('${src}')`;
        lens.style.backgroundSize = `${imgRect.width * zoom}px ${imgRect.height * zoom}px`;

        const bgX = -(x * zoom - lens.offsetWidth / 2);
        const bgY = -(y * zoom - lens.offsetHeight / 2);
        lens.style.backgroundPosition = `${bgX}px ${bgY}px`;
      };

      const openModal = () => {
        if (!modal || !modalImage) return;
        const src = image.currentSrc || image.src;
        modalImage.src = src;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      };

      const closeModal = () => {
        if (!modal) return;
        modal.style.display = 'none';
        document.body.style.overflow = '';
      };

      // Desktop: mouse lens
      if (!isMobile) {
        stage.addEventListener('pointerenter', () => {
          lens.style.display = 'block';
        });

        stage.addEventListener('pointerleave', () => {
          lens.style.display = 'none';
        });

        stage.addEventListener('pointermove', (e) => {
          updateLens(e.clientX, e.clientY);
        });
      } else {
        // Mobile: click to open modal
        stage.addEventListener('click', openModal);
        stage.addEventListener('touchend', (e) => {
          // Only open modal if it wasn't a pinch gesture
          if (e.changedTouches.length === 1) {
            openModal();
          }
        });
      }

      // Modal close handlers
      if (modalClose) {
        modalClose.addEventListener('click', closeModal);
      }

      if (modalOverlay) {
        modalOverlay.addEventListener('click', closeModal);
      }

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
          closeModal();
        }
      });

      // Refresh lens source if the image swaps to PNG fallback.
      image.addEventListener('load', () => {
        const src = image.currentSrc || image.src;
        lens.style.backgroundImage = `url('${src}')`;
      });
    })();
  </script>
</BaseLayout>
