---
import BaseLayout from '../layouts/BaseLayout.astro';
import { withBase } from '../utils/withBase';

const apiBase = import.meta.env.PUBLIC_PUZZLEGEN_URL ?? 'https://puzzle-generator-vkgt.onrender.com';
const apiBaseJSON = JSON.stringify(apiBase);
---
<BaseLayout
  title="Puzzle Generator"
  description="Genera puzzles 3D, visualiza soluciones y descarga STL listo para imprimir."
>
  <section class="puzzle-hero">
    <h1>Puzzle Generator 3D</h1>
    <p>
      Generador de puzzles 3D con vista isom√©trica, b√∫squeda de soluciones y exportaci√≥n a STL.
      Servido desde un backend Python en Render.
    </p>
    <div class="hero-actions">
      <a class="button" href={withBase('/posts')}>Volver al blog</a>
      <a class="button secondary" href={apiBase} target="_blank" rel="noreferrer">Abrir backend</a>
    </div>
  </section>

  <link
    rel="stylesheet"
    id="backend-style"
    href={`${apiBase}/static/style.css`}
    media="print"
    onload="this.media='all'"
  />
  <style id="backend-fallback-style">
    #backend-wait {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: var(--card, #0b0f16);
      color: var(--text, #f4f6fb);
      border-radius: 12px;
      border: 1px solid var(--border, #222);
      min-height: 180px;
    }
    .backend-msg { color: var(--text, #f4f6fb); }
    .backend-status { color: var(--muted, #9aa1b5); font-style: italic; }
    .puzzle-shell { position: relative; }
    .puzzle-shell.blocked .container { display: none; }
  </style>
  <section class="puzzle-shell blocked">
    <div id="backend-wait" class="backend-wait" aria-live="polite">
      <div class="loader" aria-hidden="true">üß©</div>
      <div class="backend-msg">
        <strong>Arrancando backend‚Ä¶</strong>
        <span class="backend-note">Render se est√° despertando. Puede tardar ~1 minuto la primera vez.</span>
        <span class="backend-status" aria-live="polite"></span>
      </div>
    </div>
    <div class="container" id="puzzle-container" aria-live="polite">
      <h1>üß© Puzzle Generator Web</h1>
      <p class="subtitle">
        Crea puzzles 3D con visualizaci√≥n isom√©trica e imprime en tu impresora 3D.
      </p>

      <div class="panel config-panel">
        <h2>‚öôÔ∏è Configuraci√≥n del Puzzle</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Filas (M):</label>
            <input type="number" id="M" value="5" min="2" max="20" />
          </div>
          <div class="form-group">
            <label>Columnas (N):</label>
            <input type="number" id="N" value="6" min="2" max="20" />
          </div>
          <div class="form-group">
            <label>Tama√±o m√≠nimo (celdas):</label>
            <input type="number" id="min_size" value="3" min="1" max="10" />
          </div>
          <div class="form-group">
            <label>Tama√±o m√°ximo (celdas):</label>
            <input type="number" id="max_size" value="4" min="1" max="10" />
          </div>
          <div class="form-group">
            <label>Modo:</label>
            <select id="mode">
              <option value="Fast (original)">R√°pido (original)</option>
              <option value="Force minimum">Forzar m√≠nimo</option>
              <option value="Balanced" selected>Equilibrado</option>
              <option value="Strategic">Estrat√©gico</option>
            </select>
          </div>
          <div class="form-group">
            <label>Bordes bloqueados:</label>
            <select id="border_prob">
              <option value="0">0%</option>
              <option value="25" selected>25%</option>
              <option value="50">50%</option>
              <option value="75">75%</option>
            </select>
          </div>
          <div class="form-group">
            <label>Celdas aire:</label>
            <select id="air_prob">
              <option value="0" selected>0%</option>
              <option value="5">5%</option>
              <option value="10">10%</option>
              <option value="15">15%</option>
            </select>
          </div>
        </div>
        <button id="generate-btn" class="btn btn-primary">‚ñ∂ Generar Puzzle</button>
      </div>

      <div id="status" class="status"></div>

      <div class="canvas-area">
        <div class="canvas-section">
          <h3>üß© Puzzle</h3>
          <div class="view-controls">
            <button class="view-btn active" id="btn-isometric" onclick="switchView(event, 'isometric')">Isom√©trico</button>
            <button class="view-btn" id="btn-flat" onclick="switchView(event, 'flat')">Plano</button>
          </div>
          <canvas id="puzzle-canvas" width="600" height="600"></canvas>
        </div>
        <div class="canvas-section">
          <h3>üé® Galer√≠a de Piezas</h3>
          <canvas id="gallery-canvas" width="500" height="600"></canvas>
        </div>
      </div>

      <div class="panel solutions-panel">
        <h2>üîç Buscar Soluciones</h2>
        <div class="solution-controls">
          <button id="solve-10-btn" class="btn">Buscar 10 soluciones</button>
          <button id="solve-50-btn" class="btn">Buscar 50 soluciones</button>
          <button id="prev-btn" class="btn">‚óÄ Anterior</button>
          <button id="next-btn" class="btn">‚ñ∂ Siguiente</button>
          <button id="original-btn" class="btn">Original</button>
        </div>
        <div id="solution-info" class="solution-info">Soluci√≥n: 0 (Original) | Encontradas: 0</div>
      </div>

      <div class="panel export-panel">
        <h2>üñ®Ô∏è Exportar a STL para Impresi√≥n 3D</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Tama√±o cubo (mm):</label>
            <input type="number" id="stl_cube_size" value="10" step="0.5" />
          </div>
          <div class="form-group">
            <label>Altura piezas (mm):</label>
            <input type="number" id="stl_height" value="2" step="0.5" />
          </div>
          <div class="form-group">
            <label>Tolerancia (mm):</label>
            <input type="number" id="stl_tolerance" value="0.3" step="0.1" />
          </div>
          <div class="form-group">
            <label>Separaci√≥n (mm):</label>
            <input type="number" id="stl_gap" value="5" step="0.5" />
          </div>
          <div class="form-group">
            <label>Tama√±o borde base (mm):</label>
            <input type="number" id="stl_border" value="5" step="0.5" />
          </div>
          <div class="form-group">
            <label>Espesor base (mm):</label>
            <input type="number" id="stl_base_thickness" value="1" step="0.5" />
          </div>
          <div class="form-group">
            <label>Altura paredes (mm):</label>
            <input type="number" id="stl_wall_height" value="2" step="0.5" />
          </div>
        </div>
        <div class="export-buttons">
          <button id="export-stl-btn" class="btn btn-success">Descargar STL (Base + Piezas)</button>
        </div>
        <div id="status-viewer" class="status"></div>

        <h3 style="margin-top: 20px;">üì¶ Vista Previa 3D</h3>
        <div id="viewer-3d" style="width: 100%; height: 500px; border: 1px solid var(--border); border-radius: 12px; background-color: rgba(255,255,255,0.02);"></div>
      </div>
    </div>
  </section>
  <script set:html={`
    window.PUZZLE_API_BASE = ${apiBaseJSON};
    (function patchFetch() {
      const base = window.PUZZLE_API_BASE || '';
      const originalFetch = window.fetch.bind(window);
      window.fetch = (input, init) => {
        if (typeof input === 'string' && input.startsWith('/')) {
          return originalFetch(base + input, init);
        }
        if (input && typeof input.url === 'string' && input.url.startsWith('/')) {
          input = new Request(base + input.url, input);
        }
        return originalFetch(input, init);
      };
    })();
  `} />

  <script type="module">
    import * as THREE from 'https://esm.sh/three@0.128.0';
    import { STLLoader } from 'https://esm.sh/three@0.128.0/examples/jsm/loaders/STLLoader.js';
    import { OrbitControls } from 'https://esm.sh/three@0.128.0/examples/jsm/controls/OrbitControls.js';
    const THREE_NS = Object.assign({}, THREE, { STLLoader, OrbitControls });
    window.THREE = THREE_NS;
    window._threeReady = true;
    window.dispatchEvent(new Event('three-ready'));
  </script>
  <script>
    // Flujo robusto sin recargas autom√°ticas: mantenemos overlay hasta tener CSS y app.js cargados.
    let cssReady = false;
    let scriptReady = false;
    let healthReady = false;
    let scriptFailTimer = null;
    let cssRetries = 0;
    let scriptRetries = 0;

    const hideOverlay = () => {
      const overlay = document.getElementById('backend-wait');
      const shell = document.querySelector('.puzzle-shell');
      overlay?.classList.add('hide');
      shell?.classList.remove('blocked');
      document.getElementById('backend-fallback-style')?.remove();
      setTimeout(() => {
        try { window.dispatchEvent(new Event('resize')); } catch (_) {}
        if (typeof window.init3DViewer === 'function') {
          try { window.init3DViewer(); } catch (e) { console.warn('init3DViewer fallo:', e); }
        }
      }, 50);
    };

    const showOverlay = () => {
      const overlay = document.getElementById('backend-wait');
      const shell = document.querySelector('.puzzle-shell');
      overlay?.classList.remove('hide');
      shell?.classList.add('blocked');
    };

    const tryFinish = () => {
      // Solo liberamos cuando CSS y app.js est√°n listos
      if (!(cssReady && scriptReady)) return;
      hideOverlay();
    };

    const pingBackend = async (base) => {
      const normalized = base.endsWith('/') ? base.slice(0, -1) : base;
      try {
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), 8000);
        const res = await fetch(`${normalized}/health`, { signal: ctrl.signal });
        clearTimeout(timer);
        return res.ok;
      } catch (_) {
        return false;
      }
    };

    const startMonitor = () => {};

    const loadBackendScript = () => {
      if (scriptReady) return;
      const base = window.PUZZLE_API_BASE || '';
      const normalized = base.endsWith('/') ? base.slice(0, -1) : base;
      const s = document.createElement('script');
      const bust = `?v=${Date.now()}-${scriptRetries}`;
      s.src = `${normalized}/static/app.js${bust}`;
      s.defer = true;
      s.addEventListener('load', () => { scriptReady = true; tryFinish(); });
      s.addEventListener('error', (e) => {
        scriptRetries += 1;
        console.warn('[Puzzle] No se pudo cargar app.js del backend', e);
        const status = document.querySelector('.backend-status');
        if (status) status.textContent = 'Reintentando app.js del backend...';
        setTimeout(loadBackendScript, Math.min(4000 + scriptRetries * 500, 12000));
      });
      document.body.appendChild(s);
    };

    if (window._threeReady) {
      loadBackendScript();
    } else {
      window.addEventListener('three-ready', loadBackendScript, { once: true });
    }

    (() => {
      const link = document.getElementById('backend-style');
      if (!link) { cssReady = true; tryFinish(); return; }
      const base = window.PUZZLE_API_BASE || '';
      const normalized = base.endsWith('/') ? base.slice(0, -1) : base;
      const updateMsg = (text) => {
        const status = document.querySelector('.backend-status');
        if (status) status.textContent = text;
      };
      const reloadCss = () => {
        cssRetries += 1;
        const bust = `?v=${Date.now()}-${cssRetries}`;
        link.href = `${normalized}/static/style.css${bust}`;
        updateMsg('Reintentando estilos del backend...');
      };
      link.addEventListener('load', () => { cssReady = true; tryFinish(); });
      link.addEventListener('error', (e) => {
        console.warn('[Puzzle] No se pudo cargar style.css del backend', e);
        setTimeout(reloadCss, Math.min(3000 + cssRetries * 500, 10000));
      });
      setTimeout(() => { if (!cssReady) reloadCss(); }, 5000);
    })();

    console.info('[Puzzle] Backend base:', window.PUZZLE_API_BASE || '(default)');

    (function waitForBackend() {
      const base = window.PUZZLE_API_BASE || '';
      const loop = async () => {
        const ok = await pingBackend(base);
        if (ok) {
          healthReady = true;
          const status = document.querySelector('.backend-status');
          if (status) status.textContent = 'Backend listo, cargando interfaz...';
          // Si el backend ya responde pero a√∫n no carga CSS/JS, forzamos reintentos inmediatos
          if (!cssReady) {
            const link = document.getElementById('backend-style');
            if (link) link.dispatchEvent(new Event('error'));
          }
          if (!scriptReady) {
            loadBackendScript();
          }
          tryFinish();
          return;
        }
        setTimeout(loop, 3000);
      };
      loop();
    })();

    // Bloqueo de botones hasta que app.js est√© listo para evitar que el primer clic se pierda
    const guardIds = [
      'generate-btn','solve-10-btn','solve-50-btn','prev-btn','next-btn','original-btn','export-stl-btn','btn-isometric','btn-flat'
    ];
    const attachGuards = () => {
      guardIds.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('click', (e) => {
          if (scriptReady) return; // ya cargado, no bloqueamos
          e.preventDefault();
          e.stopPropagation();
          const status = document.getElementById('status') || document.getElementById('status-viewer');
          if (status) status.textContent = 'Cargando interfaz...';
        }, true);
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attachGuards, { once: true });
    } else {
      attachGuards();
    }
  </script>
</BaseLayout>

<style is:global>
  /* Reafirmar variables del tema: el CSS remoto del backend puede redefinir :root y romper dark/light. */
  :root {
    color-scheme: dark;
    --bg: #0d1017;
    --bg-soft: rgba(255, 255, 255, 0.02);
    --text: #e7ecf3;
    --muted: #9ca3af;
    --accent: #7cf2c9;
    --accent-2: #6cb1ff;
    --card: rgba(255, 255, 255, 0.04);
    --border: rgba(255, 255, 255, 0.08);
    --radius: 16px;
    --shadow: 0 10px 50px rgba(0, 0, 0, 0.35);
    --font: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, sans-serif;
  }

  :root[data-theme='light'] {
    color-scheme: light;
    --bg: #f7f9fc;
    --bg-soft: rgba(0, 0, 0, 0.04);
    --text: #0f172a;
    --muted: #4b5563;
    --accent: #0f9b73;
    --accent-2: #2563eb;
    --card: rgba(255, 255, 255, 0.9);
    --border: rgba(0, 0, 0, 0.08);
    --shadow: 0 12px 40px rgba(15, 23, 42, 0.12);
  }

  html, body {
    color: var(--text) !important;
    font-family: var(--font) !important;
    padding: 0 !important;
    margin: 0 !important;
  }

  :root[data-theme='light'] html, :root[data-theme='light'] body {
    color: var(--text) !important;
  }

  /* Mantener el mismo fondo (degradado) que el resto del sitio.
     El CSS remoto del backend puede intentar sobrescribir el background del body. */
  body {
    background: radial-gradient(circle at 20% 20%, rgba(124, 242, 201, 0.08), transparent 25%),
      radial-gradient(circle at 80% 0%, rgba(108, 177, 255, 0.1), transparent 30%),
      linear-gradient(135deg, #0b0f16 0%, #0d1017 50%, #0b0f16 100%) !important;
  }

  :root[data-theme='light'] body {
    background: radial-gradient(circle at 20% 20%, rgba(15, 155, 115, 0.08), transparent 25%),
      radial-gradient(circle at 80% 0%, rgba(37, 99, 235, 0.08), transparent 30%),
      linear-gradient(135deg, #f6f8fb 0%, #f1f5f9 50%, #eef2f7 100%) !important;
  }

  .container {
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  .panel, .canvas-area, .canvas-section {
    border-color: var(--border) !important;
  }

  .status { display: block; }

  /* Forzar fondo neutro si el CSS remoto trae gradiente morado */
  body.container, body .container { background: transparent !important; }

  /* Evitar que estilos externos cambien links o inputs */
  a, input, select, button { color: inherit; }

  /* Formularios: el CSS remoto suele forzar fondo claro en inputs/select */
  .container input,
  .container select,
  .container textarea {
    background: rgba(255, 255, 255, 0.03) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
    border-radius: 10px !important;
  }

  :root[data-theme='light'] .container input,
  :root[data-theme='light'] .container select,
  :root[data-theme='light'] .container textarea {
    background: rgba(255, 255, 255, 0.92) !important;
    color: var(--text) !important;
    border: 1px solid rgba(0, 0, 0, 0.12) !important;
  }

  .container input:focus,
  .container select:focus,
  .container textarea:focus {
    outline: 2px solid rgba(124, 242, 201, 0.35) !important;
    outline-offset: 2px;
  }

  :root[data-theme='light'] .container input:focus,
  :root[data-theme='light'] .container select:focus,
  :root[data-theme='light'] .container textarea:focus {
    outline: 2px solid rgba(15, 155, 115, 0.35) !important;
  }

  .container option {
    background: var(--bg) !important;
    color: var(--text) !important;
  }

  :root[data-theme='light'] .container option {
    background: #ffffff !important;
    color: var(--text) !important;
  }
</style>

<style is:global>
/* Animaciones desactivadas para evitar salto visible al cambiar de p√°gina */
.puzzle-hero {
  display: grid;
  gap: 16px;
  padding: 28px 32px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--card);
  box-shadow: var(--shadow);
  max-width: 1100px;
  margin: 0 auto;
}

.puzzle-hero h1 {
  margin: 0;
  font-size: clamp(2rem, 5vw, 3rem);
  letter-spacing: -0.02em;
  color: var(--text) !important;
  text-shadow: 0 1px 0 rgba(0,0,0,0.4);
  text-align: left;
}

.puzzle-hero p {
  margin: 0;
  color: var(--muted);
  line-height: 1.6;
}

.note {
  color: var(--muted);
  font-size: 0.95rem;
}

.puzzle-shell {
  margin-top: 20px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow);
  padding: 24px;
  max-width: 1100px;
  margin-left: auto;
  margin-right: auto;
  position: relative;
}

.container {
  background: transparent;
  box-shadow: none;
  padding: 0;
  max-width: 1200px;
  margin: 0 auto;
  color: var(--text) !important;
  font-family: var(--font);
}

body, .container h1, .container h2, .container h3, .container p, .container label {
  color: var(--text) !important;
}

.subtitle {
  text-align: left;
  color: var(--muted);
  margin: 6px 0 18px;
}

.status { display: block; }




.panel {
  background: rgba(255, 255, 255, 0.03) !important;
  border-left: 4px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
}

:root[data-theme='light'] .panel {
  background: rgba(255, 255, 255, 0.85) !important;
  border-left-color: var(--border) !important;
}

.btn {
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 16px;
  background: linear-gradient(120deg, rgba(124, 242, 201, 0.16), rgba(108, 177, 255, 0.08)) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12) !important;
  font-weight: 600;
  transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease, color 140ms ease;
}

.btn-primary,
.btn-success,
.solution-controls .btn,
.export-buttons .btn,
.view-controls .view-btn {
  background: linear-gradient(120deg, rgba(124, 242, 201, 0.26), rgba(108, 177, 255, 0.14)) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.16) !important;
}

.btn:hover,
.view-btn:hover,
.solution-controls .btn:hover,
.export-buttons .btn:hover,
.view-controls .view-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  filter: brightness(1.02);
  border-color: var(--accent) !important;
  color: var(--accent) !important;
}

:root[data-theme='light'] .btn {
  background: linear-gradient(120deg, rgba(124, 242, 201, 0.12), rgba(108, 177, 255, 0.06)) !important;
  color: var(--text) !important;
  border: 1px solid rgba(0, 0, 0, 0.08) !important;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08) !important;
}

:root[data-theme='light'] .btn-primary,
:root[data-theme='light'] .btn-success,
:root[data-theme='light'] .solution-controls .btn,
:root[data-theme='light'] .export-buttons .btn,
:root[data-theme='light'] .view-controls .view-btn {
  background: linear-gradient(120deg, rgba(124, 242, 201, 0.2), rgba(108, 177, 255, 0.1)) !important;
  color: var(--text) !important;
  border: 1px solid rgba(0, 0, 0, 0.1) !important;
  box-shadow: inset 0 1px 0 rgba(124, 242, 201, 0.18), 0 10px 22px rgba(0, 0, 0, 0.1) !important;
}

:root[data-theme='light'] .btn:hover,
:root[data-theme='light'] .view-btn:hover,
:root[data-theme='light'] .solution-controls .btn:hover,
:root[data-theme='light'] .export-buttons .btn:hover,
:root[data-theme='light'] .view-controls .view-btn:hover {
  border-color: rgba(15, 155, 115, 0.6) !important;
  color: var(--accent) !important;
}

.status.info { background: rgba(37, 99, 235, 0.1); color: #9bbcf6; }
.status.success { background: rgba(34, 197, 94, 0.12); color: #98e2b1; }
.status.error { background: rgba(239, 68, 68, 0.14); color: #f9b0b0; }

.canvas-area {
  background: rgba(255, 255, 255, 0.02) !important;
  border: 1px solid var(--border) !important;
  box-shadow: var(--shadow) !important;
}

.canvas-section {
  background: rgba(255, 255, 255, 0.02) !important;
  border: 1px solid var(--border) !important;
}

.view-btn {
  border-color: var(--border) !important;
  color: var(--text) !important;
  background: transparent !important;
  border-radius: 12px;
}
.view-btn.active {
  background: linear-gradient(120deg, var(--accent), var(--accent-2)) !important;
  color: #0b1020 !important;
  border-color: rgba(124, 242, 201, 0.6) !important;
}

.solution-info {
  background: rgba(37, 99, 235, 0.1) !important;
  color: var(--text) !important;
}

.backend-wait {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 14px;
  background: var(--card);
  backdrop-filter: none;
  border-radius: inherit;
  z-index: 20;
  transition: opacity 220ms ease, visibility 220ms ease;
}

.backend-wait.hide {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.backend-msg {
  display: grid;
  gap: 4px;
  color: var(--text);
  font-weight: 600;
}

.backend-msg .backend-note {
  color: var(--muted);
  font-weight: 500;
}

.backend-msg .backend-status {
  color: var(--muted);
  font-weight: 400;
  font-style: italic;
}

.puzzle-shell.blocked {
  min-height: 220px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.puzzle-shell.blocked .container {
  display: none;
}

.puzzle-shell.blocked .backend-wait {
  position: static;
  inset: auto;
  width: 100%;
  min-height: 160px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

.loader {
  font-size: 32px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 900px) {
  .puzzle-shell { padding: 16px; }
}
</style>
